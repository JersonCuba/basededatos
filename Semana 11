-- ==============================================
-- USAR BASE DE DATOS
-- ==============================================
USE BibliotecaDB_Muchos;

-- ==============================================
-- AGREGAR TABLA DE PRÃ‰STAMOS PARA EL ANÃLISIS
-- ==============================================
CREATE TABLE IF NOT EXISTS Prestamos (
    id_prestamo INT PRIMARY KEY,
    id_usuario INT,
    id_libro INT,
    fecha_prestamo DATE,
    dias_prestamo INT,
    FOREIGN KEY (id_libro) REFERENCES Libros(id_libro)
);

-- Insertar datos de ejemplo
INSERT INTO Prestamos VALUES
(1, 1, 1, '2025-09-01', 7),
(2, 1, 2, '2025-09-10', 5),
(3, 2, 2, '2025-09-12', 10),
(4, 2, 3, '2025-09-15', 3),
(5, 3, 3, '2025-09-20', 8);

-- ==============================================
-- FUNCIONES AGREGADAS
-- ==============================================

-- 1ï¸âƒ£ Contar cuÃ¡ntos prÃ©stamos hay en total
SELECT COUNT(*) AS Total_Prestamos
FROM Prestamos;

-- 2ï¸âƒ£ Calcular el promedio de dÃ­as de prÃ©stamo
SELECT AVG(dias_prestamo) AS Promedio_Dias
FROM Prestamos;

-- 3ï¸âƒ£ Mostrar el prÃ©stamo con mayor duraciÃ³n
SELECT MAX(dias_prestamo) AS Mayor_Duracion
FROM Prestamos;

-- 4ï¸âƒ£ Mostrar el prÃ©stamo con menor duraciÃ³n
SELECT MIN(dias_prestamo) AS Menor_Duracion
FROM Prestamos;

-- 5ï¸âƒ£ Sumar el total de dÃ­as prestados (suma general)
SELECT SUM(dias_prestamo) AS Total_Dias_Prestados
FROM Prestamos;

-- ==============================================
-- GROUP BY â€“ AGRUPAR Y RESUMIR DATOS
-- ==============================================

-- 6ï¸âƒ£ Total de prÃ©stamos por usuario
SELECT id_usuario, COUNT(*) AS Total_Prestamos
FROM Prestamos
GROUP BY id_usuario;

-- 7ï¸âƒ£ Promedio de duraciÃ³n de prÃ©stamos por usuario
SELECT id_usuario, AVG(dias_prestamo) AS Promedio_Dias
FROM Prestamos
GROUP BY id_usuario;

-- 8ï¸âƒ£ Total de dÃ­as prestados por cada libro
SELECT id_libro, SUM(dias_prestamo) AS Total_Dias
FROM Prestamos
GROUP BY id_libro;

-- 9ï¸âƒ£ MÃ¡ximo y mÃ­nimo de duraciÃ³n por usuario
SELECT id_usuario,
       MAX(dias_prestamo) AS Maximo,
       MIN(dias_prestamo) AS Minimo
FROM Prestamos
GROUP BY id_usuario;

-- ==============================================
-- HAVING â€“ FILTRAR RESULTADOS AGRUPADOS
-- ==============================================

-- ðŸ”Ÿ Mostrar solo usuarios con mÃ¡s de 1 prÃ©stamo
SELECT id_usuario, COUNT(*) AS Total_Prestamos
FROM Prestamos
GROUP BY id_usuario
HAVING COUNT(*) > 1;

-- 1ï¸âƒ£1ï¸âƒ£ Mostrar solo libros cuyo total de dÃ­as prestados supere 10 dÃ­as
SELECT id_libro, SUM(dias_prestamo) AS Total_Dias
FROM Prestamos
GROUP BY id_libro
HAVING SUM(dias_prestamo) > 10;

-- 1ï¸âƒ£2ï¸âƒ£ Mostrar usuarios cuyo promedio de dÃ­as prestados sea mayor a 6
SELECT id_usuario, AVG(dias_prestamo) AS Promedio_Dias
FROM Prestamos
GROUP BY id_usuario
HAVING AVG(dias_prestamo) > 6;
